apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: torch-ddp-mnist
spec:
  slotsPerWorker: 1
  sshAuthMountPath: /home/mpiuser/.ssh
  runPolicy:
    cleanPodPolicy: Running
    ttlSecondsAfterFinished: 304800
  launcherCreationPolicy: WaitForWorkersReady
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: launcher
              image: docker.io/benepstein8/torch-ddp-mpi:v1.1
              imagePullPolicy: Always
              env:
                # Paths for HPC-X Open MPI bundled in the NGC base image
                - name: PATH
                  value: /opt/hpcx/ompi/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
                - name: LD_LIBRARY_PATH
                  value: /opt/hpcx/ompi/lib:/opt/hpcx/ucx/lib:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu
                # NCCL stability on Ethernet
                - name: NCCL_DEBUG
                  value: INFO
                - name: TORCH_NCCL_ASYNC_ERROR_HANDLING
                  value: "1"
                # Extra torch debug while iterating
                - name: TORCH_DISTRIBUTED_DEBUG
                  value: DETAIL
              command: ["/bin/bash","-lc"]
              args:
                - |
                  set -euo pipefail

                  # Derive a single shared rendezvous target from the first host in the MPI hostfile
                  export MASTER_HOST=$(head -n1 /etc/mpi/hostfile | awk '{print $1}')
                  export MASTER_ADDR=$(getent hosts "${MASTER_HOST}" | awk '{print $1}')
                  export MASTER_PORT=${MASTER_PORT:-29500}
                  export WORLD_SIZE=${WORLD_SIZE:-2}

                  echo "MASTER_HOST=${MASTER_HOST} MASTER_ADDR=${MASTER_ADDR} MASTER_PORT=${MASTER_PORT} WORLD_SIZE=${WORLD_SIZE}"

                  mpirun -np ${WORLD_SIZE} \
                    -bind-to none -map-by slot \
                    -mca btl ^openib \
                    -x MASTER_ADDR -x MASTER_PORT -x WORLD_SIZE \
                    -x NCCL_DEBUG -x NCCL_ASYNC_ERROR_HANDLING \
                    -x TORCH_DISTRIBUTED_DEBUG \
                    -x LD_LIBRARY_PATH -x PATH \
                    -x OMPI_MCA_btl_vader_single_copy_mechanism=none \
                    bash -lc '
                      export RANK=${OMPI_COMM_WORLD_RANK}
                      export LOCAL_RANK=${OMPI_COMM_WORLD_LOCAL_RANK}
                      # Optional backend override via env, defaults to nccl in your script
                      python /workspace/torch_mnist_ddp.py
                    '
              securityContext:
                runAsUser: 10001
                runAsNonRoot: true
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
    Worker:
      replicas: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: worker
              image: docker.io/benepstein8/torch-ddp-mpi:v1.1
              imagePullPolicy: Always
              ports:
                - containerPort: 2222
                  name: ssh
                - containerPort: 29500
                  name: ddp
              env:
                - name: PATH
                  value: /opt/hpcx/ompi/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
                - name: LD_LIBRARY_PATH
                  value: /opt/hpcx/ompi/lib:/opt/hpcx/ucx/lib:/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu
                - name: OMPI_MCA_btl_vader_single_copy_mechanism
                  value: none
                - name: NCCL_DEBUG
                  value: INFO
                - name: TORCH_NCCL_ASYNC_ERROR_HANDLING
                  value: "1"
                - name: TORCH_DISTRIBUTED_DEBUG
                  value: DETAIL
              resources:
                requests:
                  nvidia.com/gpu: 1
                limits:
                  nvidia.com/gpu: 1
              securityContext:
                runAsUser: 10001
                runAsNonRoot: true
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
              command: ["/bin/bash","-lc"]
              args:
                - |
                  set -euo pipefail
                  exec /usr/sbin/sshd -D -e -f /home/mpiuser/.sshd_config
